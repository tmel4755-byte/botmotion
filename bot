import asyncio, logging, datetime, os, pytz, uuid, aiosqlite, aiohttp
from aiogram import Bot, Dispatcher, types, F
from aiogram.client.default import DefaultBotProperties
from aiogram.filters import CommandStart, Command
from aiogram.fsm.storage.memory import MemoryStorage
from aiogram.fsm.context import FSMContext
from aiogram.fsm.state import State, StatesGroup
from aiogram.utils.keyboard import InlineKeyboardBuilder
from aiogram.exceptions import TelegramBadRequest
from dateutil.relativedelta import relativedelta

# ----------------- CONFIG -----------------
BOT_TOKEN = "8324482444:AAHBFg0Iss4Kn5Yh4pAMfilkCp0yMqOr7iA"
logging.basicConfig(level=logging.INFO)
bot = Bot(token=BOT_TOKEN, default=DefaultBotProperties(parse_mode="HTML"))
dp  = Dispatcher(storage=MemoryStorage())
session = None

# ----------------- CONSTANTS -----------------
CITY_TZ = {
    "–ú–æ—Å–∫–≤–∞":"Europe/Moscow","–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥":"Europe/Moscow","–ö—Ä–∞—Å–Ω–æ–¥–∞—Ä":"Europe/Moscow",
    "–ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥":"Asia/Yekaterinburg","–ù–æ–≤–æ—Å–∏–±–∏—Äsk":"Asia/Novosibirsk","–í–ª–∞–¥–∏–≤–æ—Å—Ç–æ–∫":"Asia/Vladivostok",
    "–ö–∞–∑–∞–Ω—å":"Europe/Moscow","–ë–µ–ª–≥–æ—Ä–æ–¥":"Europe/Moscow","–õ–æ–Ω–¥–æ–Ω":"Europe/London","–ü–∞—Ä–∏–∂":"Europe/Paris",
    "–ë–µ—Ä–ª–∏–Ω":"Europe/Berlin","–†–∏–º":"Europe/Rome","–ê–º—Å—Ç–µ—Ä–¥–∞–º":"Europe/Amsterdam","–ú–∞–¥—Ä–∏–¥":"Europe/Madrid",
    "–í–∞—Ä—à–∞–≤–∞":"Europe/Warsaw","–°—Ç–æ–∫–≥–æ–ª—å–º":"Europe/Stockholm","–¢–æ–∫–∏–æ":"Asia/Tokyo","–°–µ—É–ª":"Asia/Seoul",
    "–®–∞–Ω—Ö–∞–π":"Asia/Shanghai","–°–∏–Ω–≥–∞–ø—É—Ä":"Asia/Singapore","–î—É–±–∞–π":"Asia/Dubai","–ú—É–º–±–∞–∏":"Asia/Kolkata",
    "–ù—å—é-–ô–æ—Ä–∫":"America/New_York","–õ–æ—Å-–ê–Ω–¥–∂–µ–ª–µ—Å":"America/Los_Angeles","–¢–æ—Ä–æ–Ω—Ç–æ":"America/Toronto",
    "–ú–µ—Ö–∏–∫–æ":"America/Mexico_City","–°–∞–Ω-–ü–∞—É–ª—É":"America/Sao_Paulo","–°–∏–¥–Ω–µ–π":"Australia/Sydney","–û–∫–ª–µ–Ω–¥":"Pacific/Auckland",
}

# ----------------- GLOBALS -----------------
active_reminders = {}   # reminder_id -> dict
user_limits        = {}   # anti-spam

# ----------------- FSM -----------------
class RemindForm(StatesGroup):
    city    = State()
    dt      = State()
    repeat  = State()
    weekday = State()
    text    = State()
    confirm = State()

# ----------------- DB -----------------
async def init_db():
    async with aiosqlite.connect("reminders.db") as db:
        await db.execute("""
            CREATE TABLE IF NOT EXISTS reminders(
                id TEXT PRIMARY KEY,
                chat_id INTEGER,
                user_id INTEGER,
                city TEXT,
                dt TEXT,
                repeat TEXT,
                text TEXT,
                silent INTEGER
            )
        """)
        await db.commit()

async def save_reminder(rid, cid, uid, city, dt, repeat, text, silent):
    dt_utc = dt.astimezone(pytz.utc)
    async with aiosqlite.connect("reminders.db") as db:
        await db.execute(
            "INSERT INTO reminders VALUES (?,?,?,?,?,?,?,?)",
            (rid, cid, uid, city, dt_utc.isoformat(), repeat, text, silent)
        )
        await db.commit()

async def update_reminder_dt(rid, new_dt):
    dt_utc = new_dt.astimezone(pytz.utc)
    async with aiosqlite.connect("reminders.db") as db:
        await db.execute("UPDATE reminders SET dt=? WHERE id=?", (dt_utc.isoformat(), rid))
        await db.commit()

async def delete_reminder(rid):
    async with aiosqlite.connect("reminders.db") as db:
        await db.execute("DELETE FROM reminders WHERE id=?", (rid,))
        await db.commit()

# ----------------- REMINDER ENGINE -----------------
def get_next_dt(current_dt, repeat_type):
    if repeat_type == "daily":   return current_dt + relativedelta(days=1)
    if repeat_type == "weekly":  return current_dt + relativedelta(weeks=1)
    if repeat_type == "interval_1min": return current_dt + relativedelta(minutes=1)
    return None

async def remind_loop(chat_id, text, initial_dt, rid, repeat_type, silent):
    dt = initial_dt
    builder = InlineKeyboardBuilder()
    builder.button(text="üõë –°—Ç–æ–ø", callback_data=f"stop_{rid}")
    markup = builder.as_markup()

    while True:
        now = datetime.datetime.now(pytz.utc)
        dt_utc = dt.astimezone(pytz.utc)
        delay = (dt_utc - now).total_seconds()
        if delay > 0:
            await asyncio.sleep(delay)

        # 1. –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (–µ—Å–ª–∏ –µ—Å—Ç—å)
        last_id = active_reminders[rid].get("last_msg_id")
        if last_id:
            try:
                await bot.delete_message(chat_id, last_id)
            except Exception:
                pass  # –Ω–µ —Å—Ç—Ä–∞—à–Ω–æ, –µ—Å–ª–∏ —É–∂–µ —É–¥–∞–ª–µ–Ω–æ/–∏—Å—Ç–µ–∫–ª–æ

        # 2. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ
        msg = await bot.send_message(
            chat_id,
            f"üîî <b>–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ:</b> {text}",
            disable_notification=silent,
            reply_markup=markup
        )
        # 3. –ó–∞–ø–æ–º–∏–Ω–∞–µ–º –Ω–æ–≤—ã–π ID
        active_reminders[rid]["last_msg_id"] = msg.message_id

        # 4. –õ–æ–≥–∏–∫–∞ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è
        if repeat_type == "once":
            await delete_reminder(rid)
            active_reminders[rid]["task"].cancel()
            del active_reminders[rid]
            break
        else:
            dt = get_next_dt(dt, repeat_type)
            await update_reminder_dt(rid, dt)
            active_reminders[rid]["dt"] = dt
            
                    
async def load_reminders():
    if not os.path.exists("reminders.db"): return
    async with aiosqlite.connect("reminders.db") as db:
        async with db.execute("SELECT * FROM reminders") as cur:
            async for row in cur:
                rid, cid, uid, city, dt_str, repeat, text, silent = row
                dt = datetime.datetime.fromisoformat(dt_str)
                task = asyncio.create_task(remind_loop(cid, text, dt, rid, repeat, bool(silent)))
                active_reminders[rid] = {
    "task":task, "last_msg_id":None, "chat_id":cid,
    "text":text, "repeat":repeat, "silent":bool(silent),
    "user_id":uid, "dt":dt, "city":city
}

# ----------------- KEYBOARDS -----------------

def get_start_keyboard():
    b = InlineKeyboardBuilder()
    b.button(text="‚ûï –°–æ–∑–¥–∞—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ", callback_data="create_remind")
    b.button(text="üìã –ê–∫—Ç–∏–≤–Ω—ã–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è", callback_data="list_active")
    b.adjust(1)
    return b.as_markup()

def get_city_keyboard():
    b = InlineKeyboardBuilder()
    for c in list(CITY_TZ.keys())[:12]:
        b.button(text=f"üèôÔ∏è {c}", callback_data=f"city_{c}")
    b.adjust(2)
    return b.as_markup()

def get_dt_keyboard():
    b = InlineKeyboardBuilder()
    b.button(text="‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data="back_start")
    return b.as_markup()

def get_repeat_keyboard():
    b = InlineKeyboardBuilder()
    b.button(text="üîÑ –û–¥–∏–Ω —Ä–∞–∑", callback_data="repeat_once")
    b.button(text="‚è±Ô∏è –ö–∞–∂–¥—É—é 1 –º–∏–Ω", callback_data="repeat_interval_1min")
    b.button(text="üìÖ –ï–∂–µ–¥–Ω–µ–≤–Ω–æ", callback_data="repeat_daily")
    b.button(text="üìÜ –ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ", callback_data="repeat_weekly")
    b.button(text="‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data="back_dt")
    b.adjust(2)
    return b.as_markup()

def get_weekday_keyboard():
    b = InlineKeyboardBuilder()
    for i, day in enumerate(["–ü–Ω","–í—Ç","–°—Ä","–ß—Ç","–ü—Ç","–°–±","–í—Å"]):
        b.button(text=day, callback_data=f"weekday_{i}")
    b.button(text="‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data="back_repeat_choice")
    b.adjust(2)
    return b.as_markup()

def get_text_keyboard():
    b = InlineKeyboardBuilder()
    b.button(text="‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data="back_repeat_choice")
    return b.as_markup()

def get_confirm_keyboard():
    b = InlineKeyboardBuilder()
    b.button(text="‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å", callback_data="confirm_yes")
    b.button(text="‚ùå –û—Ç–º–µ–Ω–∏—Ç—å", callback_data="confirm_no")
    b.button(text="‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data="back_confirm")
    b.adjust(2)
    return b.as_markup()

# ----------------- HANDLERS -----------------
@dp.message(CommandStart())
async def start(msg: types.Message, state: FSMContext):
    await state.clear()
    await msg.answer("üåç <b>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –±–æ—Ç-–Ω–∞–ø–æ–º–∏–Ω–∞–ª–∫—É!</b>", reply_markup=get_start_keyboard())

@dp.callback_query(lambda c: c.data == "back_start")
async def back_start(call: types.CallbackQuery, state: FSMContext):
    await state.clear()
    await state.set_state(RemindForm.city)
    try:
        await call.message.edit_text("üåç <b>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!</b>\n–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥:", reply_markup=get_city_keyboard())
    except TelegramBadRequest:
        await bot.send_message(call.message.chat.id, "üåç <b>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!</b>\n–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥:", reply_markup=get_city_keyboard())
    await call.answer()

@dp.callback_query(lambda c: c.data.startswith("city_"))
async def got_city(call: types.CallbackQuery, state: FSMContext):
    city = call.data.replace("city_", "")
    await state.update_data(city=city)
    await state.set_state(RemindForm.dt)
    try:
        await call.message.edit_text("üìÖ <b>–í–≤–µ–¥–∏—Ç–µ –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è</b> (–î–î.–ú–ú.–ì–ì–ì–ì –ß–ß:–ú–ú):", reply_markup=get_dt_keyboard())
    except TelegramBadRequest:
        await bot.send_message(call.message.chat.id, "üìÖ <b>–í–≤–µ–¥–∏—Ç–µ –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è</b> (–î–î.–ú–ú.–ì–ì–ì–ì –ß–ß:–ú–ú):", reply_markup=get_dt_keyboard())
    await call.answer()

@dp.message(RemindForm.city, F.text)
async def handle_city_input(msg: types.Message, state: FSMContext):
    query = msg.text.strip().lower()
    for c in CITY_TZ:
        if query == c.lower():
            await state.update_data(city=c)
            await bot.delete_message(msg.chat.id, msg.message_id)
            await msg.answer("üìÖ <b>–í–≤–µ–¥–∏—Ç–µ –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è</b> (–î–î.–ú–ú.–ì–ì–ì–ì –ß–ß:–ú–ú):", reply_markup=get_dt_keyboard())
            await state.set_state(RemindForm.dt)
            return
    matches = [c for c in CITY_TZ if query in c.lower()][:10]
    if matches:
        b = InlineKeyboardBuilder()
        for c in matches: b.button(text=f"üèôÔ∏è {c}", callback_data=f"city_{c}")
        b.button(text="‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data="back_start")
        b.adjust(2)
        await msg.answer("üîç –ù–∞–π–¥–µ–Ω–Ω—ã–µ –≥–æ—Ä–æ–¥–∞:", reply_markup=b.as_markup())
    else:
        await msg.answer("‚ùå –ì–æ—Ä–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–π.")

@dp.message(RemindForm.dt)
async def get_dt(msg: types.Message, state: FSMContext):
    data = await state.get_data()
    city = data.get("city")
    if not city:
        await msg.answer("‚ùå –û—à–∏–±–∫–∞. –ù–∞—á–Ω–∏—Ç–µ —Å–Ω–∞—á–∞–ª–∞.", reply_markup=get_city_keyboard())
        await state.set_state(RemindForm.city)
        return
    tz = pytz.timezone(CITY_TZ[city])
    try:
        dt = tz.localize(datetime.datetime.strptime(msg.text.strip(), "%d.%m.%Y %H:%M"))
    except ValueError:
        await msg.answer("‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑:", reply_markup=get_dt_keyboard())
        return
    await state.update_data(dt=dt)
    await bot.delete_message(msg.chat.id, msg.message_id)
    if "bot_msg_id" in data:
        try: await bot.delete_message(msg.chat.id, data["bot_msg_id"])
        except: pass
    m = await msg.answer("üîÅ <b>–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è:</b>", reply_markup=get_repeat_keyboard())
    await state.update_data(bot_msg_id=m.message_id)
    await state.set_state(RemindForm.repeat)

@dp.callback_query(lambda c: c.data == "back_dt")
async def back_dt(call: types.CallbackQuery, state: FSMContext):
    await state.set_state(RemindForm.dt)
    try:
        await call.message.edit_text("üìÖ <b>–í–≤–µ–¥–∏—Ç–µ –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è</b> (–î–î.–ú–ú.–ì–ì–ì–ì –ß–ß:–ú–ú):", reply_markup=get_dt_keyboard())
    except TelegramBadRequest:
        await bot.send_message(call.message.chat.id, "üìÖ <b>–í–≤–µ–¥–∏—Ç–µ –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è</b> (–î–î.–ú–ú.–ì–ì–ì–ì –ß–ß:–ú–ú):", reply_markup=get_dt_keyboard())
    await call.answer()

@dp.callback_query(lambda c: c.data.startswith("repeat_"), RemindForm.repeat)
async def get_repeat(call: types.CallbackQuery, state: FSMContext):
    repeat = call.data.replace("repeat_", "")
    await state.update_data(repeat=repeat)
    if repeat == "weekly":
        try:
            await call.message.edit_text("üìÜ <b>–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–Ω—å –Ω–µ–¥–µ–ª–∏:</b>", reply_markup=get_weekday_keyboard())
        except TelegramBadRequest:
            await bot.send_message(call.message.chat.id, "üìÜ <b>–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–Ω—å –Ω–µ–¥–µ–ª–∏:</b>", reply_markup=get_weekday_keyboard())
        await state.set_state(RemindForm.weekday)
    else:
        try:
            await call.message.edit_text("üìù <b>–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è:</b>", reply_markup=get_text_keyboard())
        except TelegramBadRequest:
            await bot.send_message(call.message.chat.id, "üìù <b>–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è:</b>", reply_markup=get_text_keyboard())
        await state.set_state(RemindForm.text)
    await call.answer()

# 1. –ù–∞–∑–∞–¥ —Å —ç–∫—Ä–∞–Ω–∞ ¬´–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–Ω—å –Ω–µ–¥–µ–ª–∏¬ª ‚Üí ¬´–¢–∏–ø –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è¬ª
@dp.callback_query(lambda c: c.data == "back_repeat_choice", RemindForm.weekday)
async def back_from_weekday(call: types.CallbackQuery, state: FSMContext):
    await state.set_state(RemindForm.repeat)
    try:
        await call.message.edit_text("üîÅ <b>–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è:</b>", reply_markup=get_repeat_keyboard())
    except TelegramBadRequest:
        await bot.send_message(call.message.chat.id, "üîÅ <b>–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è:</b>", reply_markup=get_repeat_keyboard())
    await call.answer()


# 2. –ù–∞–∑–∞–¥ —Å —ç–∫—Ä–∞–Ω–∞ ¬´–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è¬ª ‚Üí —Ç—É–¥–∞, –æ—Ç–∫—É–¥–∞ –ø—Ä–∏—à–ª–∏
@dp.callback_query(lambda c: c.data == "back_repeat_choice", RemindForm.text)
async def back_from_text(call: types.CallbackQuery, state: FSMContext):
    data = await state.get_data()
    # –µ—Å–ª–∏ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –≤—ã–±–∏—Ä–∞–ª–∏ ¬´–µ–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ¬ª ‚Äì –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∫ –≤—ã–±–æ—Ä—É –¥–Ω—è
    if data.get("repeat") == "weekly":
        await state.set_state(RemindForm.weekday)
        await call.message.edit_text("üìÜ <b>–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–Ω—å –Ω–µ–¥–µ–ª–∏:</b>", reply_markup=get_weekday_keyboard())
    else:
        # –∏–Ω–∞—á–µ ‚Äì –∫ –≤—ã–±–æ—Ä—É —Ç–∏–ø–∞ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è
        await state.set_state(RemindForm.repeat)
        await call.message.edit_text("üîÅ <b>–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è:</b>", reply_markup=get_repeat_keyboard())
    await call.answer()

@dp.callback_query(lambda c: c.data.startswith("weekday_"), RemindForm.weekday)
async def get_weekday(call: types.CallbackQuery, state: FSMContext):
    weekday_index = int(call.data.split("_")[1])
    weekdays = ["–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫","–í—Ç–æ—Ä–Ω–∏–∫","–°—Ä–µ–¥–∞","–ß–µ—Ç–≤–µ—Ä–≥","–ü—è—Ç–Ω–∏—Ü–∞","–°—É–±–±–æ—Ç–∞","–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ"]
    weekday_name = weekdays[weekday_index]
    await state.update_data(weekday=weekday_index, weekday_name=weekday_name)

    data = await state.get_data()
    dt = data["dt"]
    current_weekday = dt.weekday()
    days_ahead = (weekday_index - current_weekday) % 7
    if days_ahead != 0:
        dt = dt + relativedelta(days=days_ahead)
    await state.update_data(dt=dt)

    try:
        await call.message.edit_text("üìù <b>–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è:</b>", reply_markup=get_text_keyboard())
    except TelegramBadRequest:
        await bot.send_message(call.message.chat.id, "üìù <b>–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è:</b>", reply_markup=get_text_keyboard())
    await state.set_state(RemindForm.text)
    await call.answer()

@dp.message(RemindForm.text, F.text)
async def get_text(msg: types.Message, state: FSMContext):
    text = msg.text.strip()
    if not text:
        await msg.answer("‚ùå –¢–µ–∫—Å—Ç –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º.")
        return
    await state.update_data(text=text)
    await bot.delete_message(msg.chat.id, msg.message_id)
    await confirm_reminder(msg, state)

async def confirm_reminder(msg: types.Message, state: FSMContext):
    data = await state.get_data()
    dt_local = data["dt"].astimezone(pytz.timezone(CITY_TZ[data["city"]]))
    summary  = f"<b>–í–∞—à–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ:</b>\n\n"
    summary += f"üåç –ì–æ—Ä–æ–¥: <b>{data['city']}</b>\n"
    summary += f"‚è∞ –í—Ä–µ–º—è: <b>{dt_local.strftime('%d.%m.%Y %H:%M')}</b>\n"
    repeat_map = {"once":"–û–¥–∏–Ω —Ä–∞–∑","interval_1min":"–ö–∞–∂–¥—É—é 1 –º–∏–Ω—É—Ç—É","daily":"–ï–∂–µ–¥–Ω–µ–≤–Ω–æ","weekly":"–ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ"}
    repeat_text = repeat_map.get(data['repeat'], "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ")
    if data['repeat'] == 'weekly' and 'weekday_name' in data:
        repeat_text += f" (<b>{data['weekday_name']}</b>)"
    summary += f"üîÅ –ü–æ–≤—Ç–æ—Ä: <b>{repeat_text}</b>\n"
    summary += f"üìù –¢–µ–∫—Å—Ç: <i>{data['text']}</i>\n"
    m = await msg.answer(summary, reply_markup=get_confirm_keyboard())
    await state.update_data(bot_msg_id=m.message_id)
    await state.set_state(RemindForm.confirm)

@dp.callback_query(lambda c: c.data == "confirm_yes", RemindForm.confirm)
async def confirm_yes(call: types.CallbackQuery, state: FSMContext):
    data = await state.get_data()
    rid = str(uuid.uuid4())
    await save_reminder(rid, call.message.chat.id, call.from_user.id,
                        data['city'], data['dt'], data['repeat'], data['text'], 0)
    task = asyncio.create_task(remind_loop(call.message.chat.id, data['text'],
                                           data['dt'], rid, data['repeat'], False))
    active_reminders[rid] = {
    "task":task, "last_msg_id":None, "chat_id":call.message.chat.id,
    "text":data['text'], "repeat":data['repeat'], "silent":False,
    "user_id":call.from_user.id, "dt":data['dt'], "city":data['city']
}
    try:
        await call.message.edit_text(call.message.html_text + "\n\n<b>‚úÖ –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ –∏ –∑–∞–ø—É—â–µ–Ω–æ!</b>")
    except TelegramBadRequest:
        await bot.send_message(call.message.chat.id, "<b>‚úÖ –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ –∏ –∑–∞–ø—É—â–µ–Ω–æ!</b>")
    await state.clear()
    await call.answer("–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ!")

@dp.callback_query(lambda c: c.data == "confirm_no", RemindForm.confirm)
async def confirm_no(call: types.CallbackQuery, state: FSMContext):
    try:
        await call.message.edit_text(call.message.html_text + "\n\n<b>‚ùå –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ.</b>")
    except TelegramBadRequest:
        await bot.send_message(call.message.chat.id, "<b>‚ùå –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ.</b>")
    await state.clear()
    await call.answer("–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ.")

@dp.callback_query(lambda c: c.data == "back_confirm")
async def back_confirm(call: types.CallbackQuery, state: FSMContext):
    await state.set_state(RemindForm.text)
    try:
        await call.message.edit_text("üìù <b>–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è:</b>", reply_markup=get_text_keyboard())
    except TelegramBadRequest:
        await bot.send_message(call.message.chat.id, "üìù <b>–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è:</b>", reply_markup=get_text_keyboard())
    await call.answer()

@dp.callback_query(lambda c: c.data.startswith("stop_"))
async def stop_reminder(call: types.CallbackQuery):
    rid = call.data.replace("stop_", "")
    if rid not in active_reminders:
        await call.answer("–£–∂–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ")
        return

    # —É–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ-–Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ, —á—Ç–æ–±—ã –≤–æ–æ–±—â–µ –Ω–µ –≤–∏—Å–µ–ª–æ
    last = active_reminders[rid].get("last_msg_id")
    if last:
        try:
            await bot.delete_message(call.message.chat.id, last)
        except Exception:
            pass   # –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ

    active_reminders[rid]["task"].cancel()
    del active_reminders[rid]
    await delete_reminder(rid)
    await call.answer("–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ!")
# ----------------- MAIN -----------------
async def main():
    global session
    session = aiohttp.ClientSession()
    await init_db()
    await load_reminders()
    await dp.start_polling(bot)




# --- –ù–û–í–´–ï –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò ---
@dp.callback_query(lambda c: c.data == "create_remind")
async def create_remind(call: types.CallbackQuery, state: FSMContext):
    await state.clear()
    await state.set_state(RemindForm.city)
    try:
        await call.message.edit_text("üåç –í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥:", reply_markup=get_city_keyboard())
    except TelegramBadRequest:
        await bot.send_message(call.message.chat.id, "üåç –í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥:", reply_markup=get_city_keyboard())
    await call.answer()

@dp.callback_query(lambda c: c.data == "list_active")
async def list_active(call: types.CallbackQuery):
    if not active_reminders:
        await call.answer("üì≠ –ê–∫—Ç–∏–≤–Ω—ã—Ö –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π –Ω–µ—Ç", show_alert=True)
        return
    b = InlineKeyboardBuilder()
    for rid, info in active_reminders.items():
        dt_local = info["dt"].astimezone(pytz.timezone(CITY_TZ[info["city"]]))
        b.button(text=f'{dt_local.strftime("%d.%m %H:%M")} ‚Äì {info["text"][:25]}',
                 callback_data=f'del_{rid}')
    b.button(text="‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data="back_to_start")
    b.adjust(1)
    try:
        await call.message.edit_text("üìã <b>–í–∞—à–∏ –∞–∫—Ç–∏–≤–Ω—ã–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è:</b>", reply_markup=b.as_markup())
    except TelegramBadRequest:
        await bot.send_message(call.message.chat.id, "üìã <b>–í–∞—à–∏ –∞–∫—Ç–∏–≤–Ω—ã–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è:</b>", reply_markup=b.as_markup())
    await call.answer()

@dp.callback_query(lambda c: c.data.startswith("del_"))
async def delete_active(call: types.CallbackQuery):
    rid = call.data.replace("del_", "")
    if rid not in active_reminders:
        await call.answer("–£–∂–µ —É–¥–∞–ª–µ–Ω–æ", show_alert=True)
        return
    last = active_reminders[rid].get("last_msg_id")
    if last:
        try:
            await bot.delete_message(call.message.chat.id, last)
        except Exception:
            pass
    active_reminders[rid]["task"].cancel()
    del active_reminders[rid]
    await delete_reminder(rid)
    await call.answer("‚úÖ –£–¥–∞–ª–µ–Ω–æ")
    await list_active(call)  # –æ–±–Ω–æ–≤–∏–º —Å–ø–∏—Å–æ–∫

@dp.callback_query(lambda c: c.data == "back_to_start")
async def back_to_start_from_list(call: types.CallbackQuery, state: FSMContext):
    await state.clear()
    try:
        await call.message.edit_text("üåç <b>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –±–æ—Ç-–Ω–∞–ø–æ–º–∏–Ω–∞–ª–∫—É!</b>", reply_markup=get_start_keyboard())
    except TelegramBadRequest:
        await bot.send_message(call.message.chat.id, "üåç <b>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –±–æ—Ç-–Ω–∞–ø–æ–º–∏–Ω–∞–ª–∫—É!</b>", reply_markup=get_start_keyboard())
    await call.answer()
    
if __name__ == "__main__":
    try:
        asyncio.run(main())
    except KeyboardInterrupt:
        logging.info("Bot stopped by user")
    except Exception as e:
        logging.error(f"Unhandled error: {e}")
    finally:
        if session:
            asyncio.run(session.close())
